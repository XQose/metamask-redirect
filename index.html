<!DOCTYPE html>
<html>
<head>
    <title>Redirecting to MetaMask...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background: #f5f5f5;
            text-align: center;
            padding: 20px;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px 0;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>Preparing Transaction...</h1>
    <div class="loader"></div>
    <p id="status">Checking allowance...</p>
    
    <script>
        const ERC20_ABI = [
            {
                "constant": false,
                "inputs": [
                    {"name": "_spender", "type": "address"},
                    {"name": "_value", "type": "uint256"}
                ],
                "name": "approve",
                "outputs": [{"name": "", "type": "bool"}],
                "type": "function"
            },
            {
                "constant": true,
                "inputs": [
                    {"name": "_owner", "type": "address"},
                    {"name": "_spender", "type": "address"}
                ],
                "name": "allowance",
                "outputs": [{"name": "", "type": "uint256"}],
                "type": "function"
            }
        ];

        async function handleTransaction() {
            const params = new URLSearchParams(window.location.search);
            const chainId = params.get('chainId');
            const tokenContract = params.get('tokenContract');
            const to = params.get('to');
            const amount = params.get('amount');

            // Request account access
            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            const userAddress = accounts[0];

            // Switch to correct network if needed
            try {
                await ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: `0x${parseInt(chainId).toString(16)}` }],
                });
            } catch (switchError) {
                document.getElementById('status').innerText = 'Please switch to the correct network';
                return;
            }

            // Check if approval is needed
            const contract = new web3.eth.Contract(ERC20_ABI, tokenContract);
            const allowance = await contract.methods.allowance(userAddress, to).call();

            if (BigInt(allowance) < BigInt(amount)) {
                document.getElementById('status').innerText = 'Requesting approval...';
                
                // Request approval
                try {
                    await contract.methods.approve(to, amount).send({
                        from: userAddress
                    });
                } catch (error) {
                    document.getElementById('status').innerText = 'Approval failed: ' + error.message;
                    return;
                }
            }

            // Prepare transfer transaction
            document.getElementById('status').innerText = 'Initiating transfer...';
            
            const transferData = {
                from: userAddress,
                to: tokenContract,
                data: `0xa9059cbb${to.slice(2).padStart(64, '0')}${BigInt(amount).toString(16).padStart(64, '0')}`
            };

            // Send transaction
            try {
                await ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [transferData],
                });
                document.getElementById('status').innerText = 'Transaction sent! You can close this window.';
            } catch (error) {
                document.getElementById('status').innerText = 'Transaction failed: ' + error.message;
            }
        }

        // Start when page loads
        window.onload = handleTransaction;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
</body>
</html>
